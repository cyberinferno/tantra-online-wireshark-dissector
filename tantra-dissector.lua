-- Wireshark dissector for Tantra Online

-- Create Proto object
tantra = Proto("tantra", "Tantra Online - Game Server Protocol")

local f = tantra.fields

local opcodes = {
    [0x1001] = "Login request",
    [0x1002] = "World list request",
    [0x1003] = "Move zone server request",
    [0x1004] = "Version check",
    [0x1011] = "Character list request",
    [0x1012] = "Character create request",
    [0x1013] = "Character remove request",
    [0x1014] = "Character select request",
    [0x1015] = "Exit zone server request",
    [0x1021] = "Character logout request",
    [0x1022] = "Remove mob request",
    [0x1023] = "Other character logout notify request",
    [0x1101] = "Character init request",
    [0x1105] = "Initialise guild request",
    [0x1106] = "Initialise address book request",
    [0x1108] = "Character history request",
    [0x1109] = "Initialise equipment request",
    [0x1111] = "Initialise monster NPC request",
    [0x1112] = "Initialise other mob request",
    [0x1113] = "Initialise real address book request",
    [0x1114] = "Initialise real guild request",
    [0x1115] = "Initialise real guild member request",
    [0x1121] = "Initialise item request",
    [0x1161] = "Initialise world user count request",
    [0x1171] = "Initialise guild member request",
    [0x1201] = "Character move request",
    [0x1202] = "Other character move request",
    [0x1206] = "Monster move step request",
    [0x1207] = "Monster move N step request",
    [0x1208] = "Monster move end request",
    [0x1223] = "Item use request",
    [0x1224] = "Item use broadcast request",
    [0x1225] = "Item remove request",
    [0x1227] = "Character move broadcast request",
    [0x1301] = "Attack character request",
    [0x1302] = "Attack character broadcast request",
    [0x1401] = "Item equipment request",
    [0x1402] = "Item equipment broadcast request",
    [0x1411] = "Item abrasion request",
    [0x1412] = "Item abrasion broadcast request",
    [0x1701] = "Quest history request",
    [0x1702] = "Quest dialog request",
    [0x1703] = "Quest notify level reqeust",
    [0x1831] = "Character ping request",
    [0x2001] = "Skill register request",
    [0x2002] = "Skill register",
    [0x2003] = "Skill select request",
    [0x2004] = "Skill select broadcast request",
    [0x2011] = "Skill use2 character request",
    [0x2012] = "Skill ready character broadcast request",
    [0x2013] = "Skill attack character request",
    [0x2014] = "Skill attack character broadcast request",
    [0x2021] = "Skill level UP request",
    [0x2022] = "Shop skill list request",
    [0x2305] = "My entyr list request",
    [0x2306] = "Trade Item seek request",
    [0x2541] = "Trouble report request",
    [0x2542] = "Trouble report list request",
    [0x2543] = "Trouble report set request",
    [0x2561] = "Character info request",
    [0x2562] = "Character equipment request",
    [0x2563] = "Character skill request",
    [0x2571] = "CLOSE character request",
    [0x2603] = "Join address book request",
    [0x2604] = "Join address book notify",
    [0x2605] = "Join address book result request",
    [0x2606] = "Join address book result notify request",
    [0x2607] = "Address book member delete request",
    [0x2608] = "Address book member delete notify request",
    [0x2611] = "Address book group add request",
    [0x2612] = "Address book group delete request",
    [0x2613] = "Address book group move request",
    [0x2614] = "Address book group RENAME request",
    [0x2621] = "Address book status request",
    [0x3210] = "Learn skill request",
    [0x3220] = "Cast skill request",
    [0x3230] = "Cast skill broadcast request",
    [0x3240] = "Cast unit skill request",
    [0x3250] = "Cast area skill request",
    [0x3260] = "Debuffer skill request",
    [0x3300] = "Character ACT request",
    [0x3310] = "Character ACT broadcast request",
    [0x3500] = "Update UI request",
    [0x3501] = "Update status request",
    [0x3510] = "Level up broadcast request",
    [0x3520] = "Increase chakra request",
    [0x1131] = "Initialise regen character request",
    [0x1203] = "Item move request",
    [0x1209] = "Item drop request",
    [0x120A] = "Item get request",
    [0x1231] = "Move portal request",
    [0x1501] = "Chat request",
    [0x1503] = "Whisper chat request",
    [0x1505] = "Broadcast request",
    [0x150F] = "Appeal chat request",
    [0x2101] = "Shop Item list request",
    [0x2102] = "Item buy request",
    [0x2104] = "Item sell request",
    [0x2105] = "Item repair request",
    [0x2106] = "Item refining request",
    [0x2112] = "Prana contribution request",
    [0x2113] = "Resource barter request",
    [0x2114] = "Resource barter price request",
    [0x2201] = "Trade request",
    [0x2202] = "Trade cancel request",
    [0x2544] = "GM trouble report list request",
    [0x2545] = "GM trouble report set request",
    [0x2546] = "GM trouble report request",
    [0x2550] = "GM parameter change request",
    [0x2551] = "GM item insert request",
    [0x2552] = "GM item delete request",
    [0x2553] = "GM skill insert request",
    [0x2554] = "GM skill delete request",
    [0x2547] = "GM character search request",
    [0x9001] = "Login response",
    [0x9002] = "World list response",
    [0x9003] = "Move zone server response",
    [0x9011] = "Character list response",
    [0x9012] = "Character create response",
    [0x9013] = "Character remove response",
    [0x9014] = "Character select response",
    [0x9015] = "Exit zone server response",
    [0x9021] = "Character logout response",
    [0x9022] = "Remove mob response",
    [0x9023] = "Other character logout notify response",
    [0x9101] = "Character initialize response",
    [0x9104] = "Initialize skill response",
    [0x9105] = "Initialize guild response",
    [0x9106] = "Initialize address book response",
    [0x9108] = "Character history response",
    [0x9109] = "Initialize equipment response",
    [0x9111] = "Initialize monster NPC response",
    [0x9112] = "Initialize other mob response",
    [0x9113] = "Initialize real address book response",
    [0x9114] = "Initialize real guild response",
    [0x9115] = "Initialize real guild member response",
    [0x9121] = "Initialize item response",
    [0x9161] = "Initialize world user count response",
    [0x9171] = "Initialize guild member response",
    [0x9201] = "Character move response",
    [0x9202] = "Other character move response",
    [0x9206] = "Monster move step response",
    [0x9207] = "Monster move N step response",
    [0x9208] = "Monster move end response",
    [0x9223] = "Item use response",
    [0x9224] = "Item use broadcast response",
    [0x9225] = "Item remove response",
    [0x9227] = "Character move broadcast response",
    [0x9301] = "Attack character response",
    [0x9302] = "Attack character broadcast response",
    [0x9401] = "Item equipment response",
    [0x9402] = "Item equipment broadcast response",
    [0x9411] = "Item abrasion response",
    [0x9412] = "Item abrasion broadcast response",
    [0x9701] = "Quest history response",
    [0x9702] = "Quest dialog response",
    [0x9703] = "Quest notify level response",
    [0x9702] = "Quest dialog response",
    [0x9703] = "Quest notify levelled response",
    [0xA001] = "Skill register response",
    [0xA002] = "Skill registered response",
    [0xA003] = "Skill select response",
    [0xA004] = "Skill select broadcast response",
    [0xA011] = "Skill use2 character response",
    [0xA012] = "Skill READY character broadcast",
    [0xA013] = "Skill attack character response",
    [0xA014] = "Skill attack character broadcast",
    [0xA021] = "Skill level up response",
    [0xA022] = "SHOP skill list response",
    [0xA541] = "Trouble report response",
    [0xA542] = "Trouble report list response",
    [0xA543] = "Trouble report set response",
    [0xA561] = "Character info response",
    [0xA562] = "Character equipment response",
    [0xA563] = "Character skill response",
    [0xA571] = "Close character response",
    [0xA603] = "Join address book response",
    [0xA604] = "Join address book notify response",
    [0xA605] = "Join address book result response",
    [0xA606] = "Join address book result notify response",
    [0xA607] = "Address book member delete response",
    [0xA608] = "Address book member delete notify response",
    [0xA611] = "Address book group add response",
    [0xA612] = "Address book group delete response",
    [0xA613] = "Address book group move response",
    [0xA614] = "Address book group rename response",
    [0xA621] = "Address book status response",
    [0xB210] = "LEARN skill response",
    [0xB220] = "Cast skill response",
    [0xB230] = "Cast skill broadcast response",
    [0xB300] = "Character ACT response",
    [0xB310] = "Character ACT broadcast response",
    [0xB500] = "Update UI response",
    [0xB501] = "Update status response",
    [0xB510] = "Level up broadcast response",
    [0xB520] = "Increase chakra response",
    [0xB560] = "Fire FX broadcast response",
    [0x9131] = "Initialize regen character response",
    [0x9203] = "Item move response",
    [0x9204] = "MAP item appear response",
    [0x9205] = "MAP item disappear response",
    [0x9209] = "Item drop response",
    [0x920A] = "Item get response",
    [0x920B] = "Item set response",
    [0x920C] = "Equip set response",
    [0x9231] = "Move portal response",
    [0x9501] = "Chat response",
    [0x9502] = "Notify chat response",
    [0x9503] = "Whisper chat response",
    [0x9504] = "Notify whisper chat response",
    [0x9506] = "Notify broadcast response",
    [0x950F] = "Appeal chat response",
    [0xA101] = "Shop item list response",
    [0xA102] = "Item buy response",
    [0xA104] = "Item sell response",
    [0xA105] = "Item repair response",
    [0xA106] = "Item refining response",
    [0xA112] = "Prana contribution response",
    [0xA113] = "Resource barter response",
    [0xA114] = "Resource barter price response",
    [0xA202] = "Trade cancel response",
    [0xA544] = "GM trouble report list response",
    [0xA545] = "GM trouble report set response",
    [0xA546] = "GM trouble report response",
    [0xA548] = "Initialize item response",
    [0xA549] = "Initialize skill response",
    [0xA550] = "GM parameter change response",
    [0xA551] = "GM Item insert response",
    [0xA552] = "GM Item delete response",
    [0xA553] = "GM Skill insert response",
    [0xA554] = "GM Skill delete response",
    [0xA547] = "GM Character search response",
    [0x1181] = "Trimuriti Count message",
    [0x1912] = "Beauty message",
    [0x1981] = "Class message",
    [0x1980] = "Toggle button message",
    [0x1990] = "Change target message",
    [0x1141] = "Trimurity select message",
    [0x1226] = "Money move message",
    [0x1241] = "Move other zone message",
    [0x1421] = "Mob store message",
    [0x1422] = "Mob store buy message",
    [0x1423] = "Mob status message",
    [0x1507] = "Chat message",
    [0x1508] = "Broadcast message",
    [0x1510] = "Command message",
    [0x1511] = "Server command message",
    [0x1601] = "Guild info message",
    [0x1608] = "Guild member out message",
    [0x1609] = "Guild update message",
    [0x1610] = "Guild update member message",
    [0x1612] = "Guild update mark message",
    [0x1613] = "Guild notify message",
    [0x2700] = "Messenger login message",
    [0x2701] = "Messenger logout message",
    [0x2704] = "Request messenger message",
    [0x2705] = "CNF messenger message",
    [0x2706] = "Remove messenger message",
    [0x2707] = "Messenger remove list message",
    [0x2705] = "Messenger save message",
    [0x2401] = "Request party message",
    [0x2402] = "CNF party message",
    [0x2403] = "Add party message",
    [0x2404] = "Remove party message",
    [0x2407] = "Set party message",
    [0x2501] = "GM mode message",
    [0x2502] = "GM mode notify message",
    [0x2503] = "GM move position message",
    [0x2504] = "GM move to player message",
    [0x2505] = "GM kick player message",
    [0x2506] = "Warp message",
    [0x2107] = "Item contribution message",
    [0x2108] = "Refine scale message",
    [0x0008] = "User info message",
    [0x0009] = "Char initialize message",
    [0x3001] = "Cash message",
    [0x3002] = "Time message",
    [0x3003] = "Item message",
    [0x3004] = "Mail message",
    [0x3005] = "NPC command message",
    [0x3006] = "Cash2 message",
    [0x3007] = "Cash3 message",
    [0x4101] = "Challenger message",
    [0x4201] = "Time mode message",
    [0x4301] = "Trimuriti status message",
    [0x4302] = "Braman bonus message",
    [0x4401] = "Strong hold init message",
    [0x4402] = "Strong hold update message",
    [0x4403] = "Strong hold status message",
    [0x4501] = "Game event message",
    [0x4502] = "ChangeCharname message",
    [0x4601] = "Alarm message",
    [0x4602] = "Echo message",
    [0x4603] = "Who message",
    [0x4604] = "Quiz message",
    [0x4605] = "Quiz sesponse message",
    [0x4606] = "User count message",
    [0x4701] = "Yut bet message",
    [0x4702] = "Yut status message",
    [0x4703] = "Yut my money message",
    [0x4704] = "Yut move message",
    [0x4705] = "Yut get money message",
    [0x4706] = "Get money message",
    [0x4707] = "Set sales rate message",
    [0x4708] = "Castle init message",
    [0x4709] = "Castle update message",
    [0x4721] = "My rental item list message",
    [0x4722] = "Rental item list message",
    [0x4723] = "Rental item add message",
    [0x4724] = "Rental item cancel message",
    [0x4725] = "Rental get money message",
    [0x4726] = "Rental get item message",
    [0x4727] = "Set rental tex message",
    [0x4729] = "Rental store close message",
    [0x4730] = "Rental item buy message",
    [0x4731] = "Rental Stock item list message",
    [0x4731] = "Rental Stock item list message",
    [0x4741] = "Account login message",
    [0x4742] = "Chat room create message",
    [0x4743] = "Chat room join message",
    [0x4744] = "Chat room go out message",
    [0x4745] = "Chat room info message",
    [0x4746] = "Chat room list request message",
    [0x4747] = "Chat room list message",
    [0x4748] = "Chat Waiting list request message",
    [0x4749] = "Chat Waiting list message",
    [0x474A] = "Chat room invite message",
    [0x474B] = "Chat room update message",
    [0x474C] = "Chat room order message",
    [0x4852] = "Script quest message"
}

f.opcode = ProtoField.uint16("tantra.opcode", "Packet Type", base.HEX, opcodes)
f.unknown = ProtoField.uint8("tantra.unknown", "Unknown Packet Type", base.HEX)

-- Dissecting code
-- buffer is the data in the TCP packet
-- tree is the root element in the visual tree structure
function tantra.dissector(buffer, pinfo, tree)
    
    -- Add a node to the root (right below the TCP element)
    local subTree = tree:add(tantra, buffer())

    -- ignore packets less than 6 bytes long
    if buffer:len() < 6 then return end

    local offset = 0

    local opcode = buffer(offset, 2):le_uint()

    if (opcode == 0x1F44) then
        offset = offset + 4;
    elseif (opcode == 0xF321) then
        offset = offset + 2;
    end

    opcode = buffer(offset, 2):le_uint()

    if (opcodes[opcode] ~= nil) then
        subTree:add_le(f.opcode, buffer(offset, 2))
    else
        subTree:add_le(f.unknown, buffer(offset, 2))
    end
end

tcp_table = DissectorTable.get("tcp.port")
tcp_table:add(1000, tantra)
tcp_table:add(3001, tantra)
tcp_table:add(3002, tantra)
tcp_table:add(3003, tantra)
tcp_table:add(3004, tantra)
tcp_table:add(3005, tantra)
tcp_table:add(3006, tantra)
